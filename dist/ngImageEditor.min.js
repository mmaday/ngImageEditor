/*! ngImageEditor 0.1.1 | Copyright (c) 2015 sparrow.jang | MIT license */
!function(a){"use strict";var b=a.module("ngImageEditor",[]),c=function(a){this.canvas_=a,this.ctx_=a.getContext("2d"),this.bgCanvas_=document.createElement("canvas"),this.bgCtx_=this.bgCanvas_.getContext("2d"),this.bgDegrees_=null,this.blockCanvas_=document.createElement("canvas"),this.blockCtx_=this.blockCanvas_.getContext("2d"),this.blockDegrees_=null,this.copyCanvas_=null,this.copyCtx_=null};a.extend(c.prototype,{refresh:function(){var a=this.canvas_,b=a.parentNode;a.width=b.clientWidth,a.height=b.clientHeight},converterToGray_:function(){for(var a=this.ctx_,b=this.canvas_,c=a.getImageData(0,0,b.width,b.height),d=c.data,e=d.length,f=0;e>f;f+=4){var g=.34*d[f]+.5*d[f+1]+.16*d[f+2];d[f]=g,d[f+1]=g,d[f+2]=g}a.putImageData(c,0,0)},drawBackground:function(a,b,c,d){(this.bgCanvas_.width!==a.width||this.bgCanvas_.height!==a.height||this.bgDegrees_!==d)&&(this.bgCanvas_.width=a.width,this.bgCanvas_.height=a.height,this.drawRotated(this.bgCanvas_,this.bgCtx_,c,d),this.converterToGray_(this.bgCanvas_,this.bgCtx_),this.bgDegrees_=d),b.drawImage(this.bgCanvas_,0,0,a.width,a.height)},drawImageBlock:function(a,b,c,d,e,f,g,h,i,j,k){var l=a.width,m=a.height,n=h/l,o=i/m,p=d/l*f,q=e/m*g,r=f*n,s=g*o;(this.blockCanvas_.width!==f||this.blockCanvas_.height!==g||this.blockDegrees_!==k)&&(this.blockCanvas_.width=f,this.blockCanvas_.height=g,this.drawRotated(this.blockCanvas_,this.blockCtx_,c,k),this.blockDegrees_=k),j&&(b.beginPath(),b.arc(d+h/2,e+h/2,h/2,0,2*Math.PI,!0),b.clip()),b.drawImage(this.blockCanvas_,p,q,r,s,d,e,h,i)},drawRotated:function(a,b,c,d){var e=a.width,f=a.height;0!==d?(b.save(),b.translate(e/2,f/2),b.rotate(d*Math.PI/180),b.drawImage(c,-(e/2),-(f/2),e,f),b.restore()):b.drawImage(c,0,0,e,f)},render:function(a,b,c,d,e){this.widthRate=c.width/this.canvas_.width,this.heightRate=c.height/this.canvas_.height,this.drawBackground(this.canvas_,this.ctx_,a,e),this.drawImageBlock(this.canvas_,this.ctx_,a,b.left,b.top,c.width,c.height,b.width,b.height,d,e)},refreshAndRender:function(b,c,d,e,f){var g=a.isNumber(f)?f:0;this.refresh(),this.render(b,c,d,e,g)},toDataURL:function(a,b){var c=this.canvas_,d=this.copyCanvas_,e=this.copyCtx_;return d||(d=this.copyCanvas_=document.createElement("canvas"),e=this.copyCtx_=d.getContext("2d")),d.width=b.width,d.height=b.height,e.drawImage(c,b.left,b.top,b.width,b.height,0,0,b.width,b.height),d.toDataURL(a)}}),b.directive("ngImageEditor",["$q",function(b){var d=function(c){var d=new Image,e=document.createElement("div"),f=b.defer(),g=a.element(document.body);return d.crossOrigin="use-credentials",e.style.cssText="width:0px;height:0px;overflow:hidden;",d.onload=function(){var a,b;a=d.width,b=d.height,e.parentNode.removeChild(e),f.resolve({width:a,height:b})},e.appendChild(d),d.src=a.isString(c)?c:c.src,g.append(e),f.promise};return{scope:{imgSrc:"=",ngImageEditor:"=",onImgChange:"&",enabledResizeSelector:"=",enabledResizeAspectLock:"=",enabledResizeCircle:"=",imgSelected:"=",imgProps:"=",rotateDegrees:"="},template:'<div ng-mousemove="move( $event )" ng-mouseup="cancel( $event )" unselectable="on"><img unselectable="on" style="opacity:0;user-drag: none;width:100%;height:100%;" crossorigin="use-credentials" ng-src="{{imgSrc}}" ng-mousedown="$event.preventDefault()" /><canvas width="100%" height="100%" style="position:absolute;top:0px;left:0px;"></canvas><div ng-image-selected enabled-resize-aspect-lock="enabledResizeAspectLock" enabled-resize-circle="enabledResizeCircle"></div></div>',controller:["$scope","$element","$attrs",function(b,e,f){var g,h,i,j,k,l;e.css({position:"relative","user-drag":"none"}).attr("unselectable","on"),h=e.find("canvas"),g=h[0],i=new c(g),j=e.find("img")[0],l=a.element(document.body);var m={imgSrc:function(c){var e=d(c);e.then(function(c){k=c,k&&b.enabledResizeAspectLock&&b.imgSelected.height!==b.imgSelected.width&&b.resizeSelected(b.imgSelected.top,b.imgSelected.left,b.imgSelected.width,b.imgSelected.height),i.refreshAndRender(j,b.imgSelected,k,b.enabledResizeCircle,b.rotateDegrees),k&&i.canvas_&&a.extend(b.imgProps||{},k,{canvasHeight:i.canvas_.height,canvasWidth:i.canvas_.width,heightRate:i.heightRate,widthRate:i.widthRate}),b.onImgChange()})},selected:function(a){null===b.dragEvent&&k&&i.refreshAndRender(j,a,k,b.enabledResizeCircle,b.rotateDegrees)},rotateDegrees:function(a){k&&i.refreshAndRender(j,b.imgSelected,k,b.enabledResizeCircle,a)}};b.$watch("imgSrc",m.imgSrc),b.$watch("rotateDegrees",m.rotateDegrees),b.$watchCollection("imgSelected",m.selected),a.extend(b,{move:function(a){var c,d,f=b.dragEvent,g=b.resizeStartEvent,h=b.imgSelected,l=e[0].clientHeight-h.height,m=e[0].clientWidth-h.width;f?(c=h.top-(f.clientY-a.clientY),d=h.left-(f.clientX-a.clientX),h.top=0>c?0:c>l?l:c,h.left=0>d?0:d>m?m:d,i.refreshAndRender(j,h,k,b.enabledResizeCircle,b.rotateDegrees),b.dragEvent=a):g&&this.onResizeSelected(a)},onResizeSelected:function(a){var c,d,e,f,g,h,i,j=b.resizeStartEvent,k=j.clientY-a.clientY,l=j.clientX-a.clientX,m=b.resizeDirection,n=b.enabledResizeAspectLock,o=b.selected;if(n)switch(c=Math.abs(k),d=Math.abs(l),m){case"nw":e=c>d?k:l,f=o.top-e,g=o.left-e,i=o.width+e,h=o.height+e;break;case"ne":e=c>d?-1*k:l,f=o.top+e,g=o.left,i=o.width-e,h=o.height-e;break;case"sw":e=c>d?-1*k:l,f=o.top,g=o.left-e,h=o.height+e,i=o.width+e;break;case"se":e=c>d?k:l,f=o.top,g=o.left,i=o.width-e,h=o.height-e}else switch(m){case"nw":f=o.top-k,g=o.left-l,i=o.width+l,h=o.height+k;break;case"ne":f=o.top-k,g=o.left,i=o.width-l,h=o.height+k;break;case"sw":f=o.top,g=o.left-l,h=o.height-k,i=o.width+l;break;case"se":f=o.top,g=o.left,i=o.width-l,h=o.height-k;break;case"tr":f=o.top-k,h=o.height+k,g=o.left,i=o.width;break;case"br":f=o.top,h=o.height-k,g=o.left,i=o.width;break;case"lc":f=o.top,h=o.height,g=o.left-l,i=o.width+l;break;case"rc":f=o.top,h=o.height,g=o.left,i=o.width-l}this.resizeSelected(f,g,i,h),b.resizeStartEvent=a},resizeSelected:function(a,c,d,f){var g=b.imgSelected,h=e[0].clientHeight-g.top,i=e[0].clientWidth-g.left;if(g.top=a>0?a<g.top+g.height?a:g.top:0,g.left=c>0?c<g.left+g.width?c:g.left:0,b.enabledResizeAspectLock){var j;d>i||f>h?(j=Math.max(Math.min(i,h),1),g.height=j,g.width=j):(j=Math.max(Math.min(d,f),1),g.width=j,g.height=j)}else g.width=i>=d?Math.max(d,1):i,g.height=h>=f?Math.max(f,1):h},cancel:function(){b.dragEvent=null,b.resizeStartEvent=null},ngImageEditor:{toDataURL:function(a){var c=a?a:"image/png";return i.toDataURL(c,b.imgSelected)},refresh:function(){i.refreshAndRender(j,b.imgSelected,k,b.enabledResizeCircle,b.rotateDegrees)}}}),l.on("mouseup",function(){b.cancel()})}]}}]),b.directive("ngImageSelected",function(){return{require:"^ngImageEditor",imgSelected:"=",enabledResizeAspectLock:"=",enabledResizeCircle:"=",template:"<div style=\"box-sizing:border-box;background:rgba(255, 255, 255, 0.1);border:2px dashed #eaeaea;cursor:all-scroll;position:absolute;\" ng-style=\"{width:imgSelected.width + 'px', height:imgSelected.height + 'px', left:imgSelected.left + 'px', top:imgSelected.top + 'px', 'border-radius':(enabledResizeCircle ? '50%' : 0)}\" ng-mousedown=\"dragEvent=$event;$event.preventDefault()\"><div ng-show=\"enabledResizeSelector\" ng-mousedown=\"onResizeBlock( $event, 'nw' )\" class=\"image-edit-resize\" style=\"cursor: nw-resize;\" ng-style=\"{top: (enabledResizeCircle ? '20%' : '-4px'), left: (enabledResizeCircle ? '7%' : '-4px')}\"></div><div ng-show=\"enabledResizeSelector\" ng-mousedown=\"onResizeBlock( $event, 'ne' )\" class=\"image-edit-resize\" style=\"cursor: ne-resize;\" ng-style=\"{top: (enabledResizeCircle ? '20%' : '-4px'), right: (enabledResizeCircle ? '7%' : '-4px')}\"></div><div ng-show=\"enabledResizeSelector\" ng-mousedown=\"onResizeBlock( $event, 'sw' )\" class=\"image-edit-resize\" style=\"cursor: sw-resize;\" ng-style=\"{bottom: (enabledResizeCircle ? '20%' : '-4px'), left: (enabledResizeCircle ? '7%' : '-4px')}\"></div><div ng-show=\"enabledResizeSelector\" ng-mousedown=\"onResizeBlock( $event, 'se' )\" class=\"image-edit-resize\" style=\"cursor: se-resize; \" ng-style=\"{bottom: (enabledResizeCircle ? '20%' : '-4px'), right: (enabledResizeCircle ? '7%' : '-4px')}\"></div>"+'<div ng-show="enabledResizeSelector" ng-hide="enabledResizeAspectLock" ng-mousedown="onResizeBlock( $event, \'tr\' )" class="image-edit-resize" style="top: -4px;right: 49%; cursor: row-resize;"></div><div ng-show="enabledResizeSelector" ng-hide="enabledResizeAspectLock" ng-mousedown="onResizeBlock( $event, \'br\' )" class="image-edit-resize" style="bottom: -4px;right: 49%; cursor: row-resize;"></div><div ng-show="enabledResizeSelector" ng-hide="enabledResizeAspectLock" ng-mousedown="onResizeBlock( $event, \'lc\' )" class="image-edit-resize" style="bottom: 49%;left: -4px; cursor: col-resize;;"></div><div ng-show="enabledResizeSelector" ng-hide="enabledResizeAspectLock" ng-mousedown="onResizeBlock( $event, \'rc\' )" class="image-edit-resize" style="bottom: 49%;right: -4px; cursor: col-resize;"></div><style type="text/css">.image-edit-resize { width: 8px;height: 8px;background: rgba(225, 225, 225, 0.8);position: absolute; }.image-edit-resize:hover { width: 10px; height: 10px;}</style></div>',replace:!0,link:function(b,c,d){a.extend(b,{onResizeBlock:function(a,b){a.preventDefault(),a.stopPropagation(),this.resizeStartEvent=a,this.resizeDirection=b}})},controller:["$scope",function(a){if(a.enabledResizeCircle&&!a.enabledResizeAspectLock)throw"Cannot use enabledResizeCircle without enabledResizeAspectLock!"}]}})}(angular);